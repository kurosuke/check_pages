# Database Design (Supabase/Postgres)

## 方針
- プロジェクト単位でURLを管理し、チームメンバーで共同利用する。
- 取得結果・差分・通知を正規化し、履歴参照と集計を両立。
- 変更検知は直近成功チェックとの比較を基本とし、可観測性のためログ・メタデータを保持。
- Supabase Auth + RLS でマルチテナントを実現。

## テーブル一覧

### projects
- `id` UUID PK
- `owner_id` UUID (Auth user.id), NOT NULL
- `name` text, NOT NULL
- `created_at` timestamptz default now()
- `updated_at` timestamptz default now()

### project_members
- `id` UUID PK
- `project_id` UUID FK → projects(id) ON DELETE CASCADE
- `user_id` UUID (Auth), NOT NULL
- `role` text enum('owner','admin','editor','viewer') default 'viewer'
- `invited_by` UUID (Auth)
- `created_at` timestamptz default now()
- Unique (project_id, user_id)

### urls
- `id` UUID PK
- `project_id` UUID FK → projects(id) ON DELETE CASCADE
- `url` text, NOT NULL, check (url like 'http%' )
- `tags` text[] default '{}'
- `note` text
- `expected_status` int default 200
- `check_interval_minutes` int default 30
- `active` boolean default true
- `last_checked_at` timestamptz
- `created_at` timestamptz default now()
- `updated_at` timestamptz default now()
- Index: (project_id, active), GIN(tags)

### keywords
- `id` UUID PK
- `url_id` UUID FK → urls(id) ON DELETE CASCADE
- `phrase` text NOT NULL
- `must_exist` boolean default true  -- true:存在必須 / false:存在したらNG
- `created_at` timestamptz default now()
- Unique (url_id, phrase, must_exist)

### checks
- `id` UUID PK
- `url_id` UUID FK → urls(id) ON DELETE CASCADE
- `started_at` timestamptz NOT NULL
- `finished_at` timestamptz
- `status` text enum('ok','changed','error') NOT NULL
- `http_status` int
- `response_ms` int
- `content_hash` text  -- 正規化本文のハッシュ
- `meta_hash` text     -- meta/og等のハッシュ
- `screenshot_path` text  -- storage キー
- `final_url` text
- `redirect_count` int
- `ssl_expires_at` timestamptz
- `error_message` text
- Index: (url_id, started_at desc)

### diffs
- `id` UUID PK
- `check_id` UUID FK → checks(id) ON DELETE CASCADE
- `field` text enum('html','meta','screenshot','keywords')
- `diff_summary` jsonb  -- 差分の要約（例: {added:[], removed:[], ratio:0.03}）
- `severity` int default 1  -- 1:low 2:medium 3:high
- `created_at` timestamptz default now()
- Index: (check_id, field)

### notifications
- `id` UUID PK
- `project_id` UUID FK → projects(id) ON DELETE CASCADE
- `type` text enum('email','discord','webhook')
- `endpoint` text  -- email or webhook URL
- `enabled` boolean default true
- `threshold` text enum('any','error','changed') default 'error'
- `created_at` timestamptz default now()
- `updated_at` timestamptz default now()

### audit_logs
- `id` bigint PK generated by identity
- `project_id` UUID
- `user_id` UUID (Auth)
- `action` text  -- e.g. url_created, url_updated, manual_check_triggered
- `target_id` UUID
- `meta` jsonb
- `created_at` timestamptz default now()
- Index: (project_id, created_at desc)

## 主要リレーション
- projects 1—n urls
- urls 1—n checks
- checks 1—n diffs
- urls 1—n keywords
- projects 1—n notifications
- projects n—n users via project_members

## 代表的DDLスニペット（抜粋）
```sql
create type check_status as enum ('ok','changed','error');
create type diff_field as enum ('html','meta','screenshot','keywords');

create table projects (
  id uuid primary key default gen_random_uuid(),
  owner_id uuid not null,
  name text not null,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

create table project_members (
  id uuid primary key default gen_random_uuid(),
  project_id uuid references projects(id) on delete cascade,
  user_id uuid not null,
  role text not null default 'viewer',
  invited_by uuid,
  created_at timestamptz default now(),
  unique(project_id, user_id)
);

create table urls (
  id uuid primary key default gen_random_uuid(),
  project_id uuid references projects(id) on delete cascade,
  url text not null,
  tags text[] default '{}',
  note text,
  expected_status int default 200,
  check_interval_minutes int default 30,
  active boolean default true,
  last_checked_at timestamptz,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);
create index idx_urls_project_active on urls(project_id, active);
create index idx_urls_tags on urls using gin(tags);

create table checks (
  id uuid primary key default gen_random_uuid(),
  url_id uuid references urls(id) on delete cascade,
  started_at timestamptz not null,
  finished_at timestamptz,
  status check_status not null,
  http_status int,
  response_ms int,
  content_hash text,
  meta_hash text,
  screenshot_path text,
  final_url text,
  redirect_count int,
  ssl_expires_at timestamptz,
  error_message text
);
create index idx_checks_url_started on checks(url_id, started_at desc);
```

## RLSポリシー方針
- 全テーブルに `project_id` または `url_id` を持たせ、プロジェクトメンバーのみアクセスを許可。
- 例: urls
```sql
alter table urls enable row level security;
create policy "urls select" on urls
  for select using (exists (select 1 from project_members pm
    where pm.project_id = urls.project_id and pm.user_id = auth.uid()));
create policy "urls modify" on urls
  for all using (exists (select 1 from project_members pm
    where pm.project_id = urls.project_id
      and pm.user_id = auth.uid()
      and pm.role in ('owner','admin','editor')));
```
- `project_members` の insert は owner/admin のみ、delete は owner/admin、自分の行は自分が閲覧可。
- `audit_logs` は select のみ、insert は service role またはバックエンド経由。

## ストレージ設計 (Supabase Storage)
- Bucket: `snapshots`
  - Path: `project/{project_id}/url/{url_id}/{check_id}/screenshot.png`
  - Path: `project/{project_id}/url/{url_id}/{check_id}/html.txt` (オプション)
- 署名付きURLで表示、RLSはサービスキー経由で取得または Edge Function で代理。

## インデックスとパフォーマンス
- `checks` は `url_id, started_at desc` で最新取得を高速化。
- 頻繁フィルタ用に `urls.tags` GIN。
- 将来: `checks(status)` でエラー一覧を早くする部分インデックス `create index on checks(url_id) where status='error';`

## マイグレーション運用
- `supabase db push` を基本とし、`db/migrations` にSQLを保存。
- enum追加時は互換性に注意（新値追加のみ、削除は不可なので新enum作成）。

## 監査・可観測性
- `audit_logs` で主要操作を記録。
- チェック実行ログは `checks` / `diffs` で完結する設計。必要に応じ `check_logs` (text[]) を追加して詳細ログを保持可能。
